<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Messaging System: Windows CI Performance Optimization</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../navtreedata.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/searchdata.js"></script>
<script type="text/javascript" src="../../search/search.js"></script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">Messaging System<span id="projectnumber">&#160;1.0.0</span>
   </div>
   <div id="projectbrief">High-Performance Cross-Platform Messaging Framework</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.8 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "../../search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="../../menudata.js"></script>
<script type="text/javascript" src="../../menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('../../',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('d8/d29/md_docs_2WINDOWS__OPTIMIZATION.html','../../'); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Windows CI Performance Optimization</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="autotoc_md1108"></a> <b>Version</b>: 1.0 <b>Date</b>: 2025-11-17 <b>Status</b>: Implemented</p>
<h1><a class="anchor" id="autotoc_md1109"></a>
Executive Summary</h1>
<p>This document outlines the performance optimizations implemented for Windows CI builds and provides additional recommendations for further improvements.</p>
<h1><a class="anchor" id="autotoc_md1110"></a>
Problem Analysis</h1>
<h2><a class="anchor" id="autotoc_md1111"></a>
Initial State (PR #31 - Before Fix)</h2>
<ul>
<li><b>Test Time</b>: 1506.99 seconds (~25 minutes)</li>
<li><b>Total CI Time</b>: 41 minutes 28 seconds</li>
<li><b>Failure</b>: <code>test_pub_sub</code> timeout</li>
<li><b>Root Cause</b>: No test-level timeouts, indefinite hangs</li>
</ul>
<h2><a class="anchor" id="autotoc_md1112"></a>
Target State (PR #30 - Success)</h2>
<ul>
<li><b>Test Time</b>: 8.39 seconds</li>
<li><b>Total CI Time</b>: ~16 minutes</li>
<li><b>Success</b>: All tests passed with proper timeouts</li>
</ul>
<h1><a class="anchor" id="autotoc_md1113"></a>
Implemented Solutions</h1>
<h2><a class="anchor" id="autotoc_md1114"></a>
1. Test-Level Timeouts ✅</h2>
<p><b>Change</b>: Added 60-second timeout to all unit tests</p>
<p><b>Files Modified</b>:</p><ul>
<li><code>test/unit/core/CMakeLists.txt</code></li>
<li><code>test/unit/backends/CMakeLists.txt</code></li>
<li><code>test/unit/di/CMakeLists.txt</code></li>
<li><code>test/unit/patterns/CMakeLists.txt</code></li>
</ul>
<p><b>Implementation</b>: </p><div class="fragment"><div class="line">add_test(NAME test_name COMMAND test_executable)</div>
<div class="line">set_tests_properties(test_name PROPERTIES TIMEOUT 60)</div>
</div><!-- fragment --><p><b>Impact</b>:</p><ul>
<li>Prevents indefinite test hangs</li>
<li>Early detection of stuck tests</li>
<li>Maximum test time: 60 seconds vs unlimited</li>
</ul>
<h2><a class="anchor" id="autotoc_md1115"></a>
2. CTest Parallel Execution ✅</h2>
<p><b>Change</b>: Configure CTest for parallel test execution</p>
<p><b>File</b>: <code>.github/workflows/ci.yml</code></p>
<p><b>Implementation</b>: </p><div class="fragment"><div class="line">ctest -C $env:BUILD_TYPE --output-on-failure --timeout 120 --parallel 4</div>
</div><!-- fragment --><p><b>Impact</b>:</p><ul>
<li>Up to 4 tests run concurrently</li>
<li>Reduced overall test execution time</li>
<li>Better CPU utilization</li>
</ul>
<h2><a class="anchor" id="autotoc_md1116"></a>
3. Build Parallelization ✅</h2>
<p><b>Change</b>: Dynamic CPU core detection for maximum parallel builds</p>
<p><b>File</b>: <code>.github/workflows/ci.yml</code></p>
<p><b>Implementation</b>: </p><div class="fragment"><div class="line">$cores = (Get-CimInstance Win32_ComputerSystem).NumberOfLogicalProcessors</div>
<div class="line">cmake --build . --config $env:BUILD_TYPE --parallel $cores</div>
</div><!-- fragment --><p><b>Impact</b>:</p><ul>
<li>Utilizes all available CPU cores</li>
<li>Faster compilation</li>
<li>Reduced build time</li>
</ul>
<h1><a class="anchor" id="autotoc_md1117"></a>
Performance Comparison</h1>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Metric   </th><th class="markdownTableHeadNone">Before   </th><th class="markdownTableHeadNone">After (Expected)   </th><th class="markdownTableHeadNone">Improvement    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">Test Execution   </td><td class="markdownTableBodyNone">1506.99s   </td><td class="markdownTableBodyNone">~10-15s   </td><td class="markdownTableBodyNone">100x faster    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">Build Time   </td><td class="markdownTableBodyNone">Unknown   </td><td class="markdownTableBodyNone">Optimized   </td><td class="markdownTableBodyNone">Parallel cores    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">Total CI Time   </td><td class="markdownTableBodyNone">41m 28s   </td><td class="markdownTableBodyNone">~16-20m   </td><td class="markdownTableBodyNone">50% reduction    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">Test Reliability   </td><td class="markdownTableBodyNone">Timeout   </td><td class="markdownTableBodyNone">Pass   </td><td class="markdownTableBodyNone">100%   </td></tr>
</table>
<h1><a class="anchor" id="autotoc_md1118"></a>
Additional Recommendations</h1>
<h2><a class="anchor" id="autotoc_md1119"></a>
Short-Term (Quick Wins)</h2>
<h3><a class="anchor" id="autotoc_md1120"></a>
1. Use Release Build for Tests</h3>
<p><b>Current</b>: Debug build (slower) <b>Proposed</b>: Release or RelWithDebInfo for faster execution</p>
<div class="fragment"><div class="line">env:</div>
<div class="line">  BUILD_TYPE: RelWithDebInfo  # Instead of Debug</div>
</div><!-- fragment --><p><b>Benefits</b>:</p><ul>
<li>2-5x faster test execution</li>
<li>More realistic performance testing</li>
<li>Smaller binary sizes</li>
</ul>
<p><b>Tradeoffs</b>:</p><ul>
<li>Harder debugging if tests fail</li>
<li>Less detailed error information</li>
</ul>
<h3><a class="anchor" id="autotoc_md1121"></a>
2. Increase vcpkg Cache Efficiency</h3>
<p><b>Current</b>: Separate cache for vcpkg tool and installed packages</p>
<p><b>Proposed</b>: Add build artifacts caching</p>
<div class="fragment"><div class="line">- name: Cache build artifacts</div>
<div class="line">  uses: actions/cache@v4</div>
<div class="line">  with:</div>
<div class="line">    path: |</div>
<div class="line">      build/</div>
<div class="line">      !build/Testing/</div>
<div class="line">    key: ${{ runner.os }}-build-${{ hashFiles(&#39;**/*.cpp&#39;, &#39;**/*.h&#39;) }}</div>
</div><!-- fragment --><p><b>Benefits</b>:</p><ul>
<li>Reuse compiled objects</li>
<li>Faster incremental builds</li>
<li>Reduced compilation time</li>
</ul>
<h3><a class="anchor" id="autotoc_md1122"></a>
3. Reduce FetchContent Downloads</h3>
<p><b>Current</b>: Downloads dependencies on every build</p>
<p><b>Proposed</b>: Cache FetchContent dependencies</p>
<div class="fragment"><div class="line">set(FETCHCONTENT_BASE_DIR &quot;${CMAKE_SOURCE_DIR}/_deps&quot; CACHE PATH &quot;FetchContent base directory&quot;)</div>
</div><!-- fragment --><p><b>Benefits</b>:</p><ul>
<li>Faster dependency resolution</li>
<li>Reduced network usage</li>
<li>More reliable builds</li>
</ul>
<h2><a class="anchor" id="autotoc_md1123"></a>
Medium-Term (Architectural)</h2>
<h3><a class="anchor" id="autotoc_md1124"></a>
1. Split Test Execution</h3>
<p><b>Current</b>: All tests in one job</p>
<p><b>Proposed</b>: Separate test categories</p>
<div class="fragment"><div class="line">strategy:</div>
<div class="line">  matrix:</div>
<div class="line">    test-category: [core, patterns, backends, di]</div>
</div><!-- fragment --><p><b>Benefits</b>:</p><ul>
<li>Parallel test execution across categories</li>
<li>Faster failure detection</li>
<li>Better resource utilization</li>
</ul>
<p><b>Estimated Time Savings</b>: 30-40%</p>
<h3><a class="anchor" id="autotoc_md1125"></a>
2. Implement Test Sharding</h3>
<p><b>Current</b>: Sequential test execution</p>
<p><b>Proposed</b>: Use CTest test sharding</p>
<div class="fragment"><div class="line">- name: Run tests (shard 1/4)</div>
<div class="line">  run: |</div>
<div class="line">    ctest --output-on-failure --tests-regex &quot;test_.*&quot; \</div>
<div class="line">          --parallel 2 --test-dir build \</div>
<div class="line">          --shard-index 1 --shard-count 4</div>
</div><!-- fragment --><p><b>Benefits</b>:</p><ul>
<li>Distribute tests across multiple jobs</li>
<li>Better parallelization</li>
<li>Reduced wall clock time</li>
</ul>
<p><b>Estimated Time Savings</b>: 50-60%</p>
<h3><a class="anchor" id="autotoc_md1126"></a>
3. Conditional Integration Tests</h3>
<p><b>Current</b>: Integration tests disabled on Windows</p>
<p><b>Proposed</b>: Enable with longer timeout</p>
<div class="fragment"><div class="line">if(WIN32)</div>
<div class="line">    set_tests_properties(integration_tests PROPERTIES TIMEOUT 300)</div>
<div class="line">else()</div>
<div class="line">    set_tests_properties(integration_tests PROPERTIES TIMEOUT 180)</div>
<div class="line">endif()</div>
</div><!-- fragment --><p><b>Benefits</b>:</p><ul>
<li>Better platform coverage</li>
<li>Early Windows-specific issue detection</li>
</ul>
<h2><a class="anchor" id="autotoc_md1127"></a>
Long-Term (Infrastructure)</h2>
<h3><a class="anchor" id="autotoc_md1128"></a>
1. Use Self-Hosted Runners</h3>
<p><b>Current</b>: GitHub-hosted runners (standard specs)</p>
<p><b>Proposed</b>: Self-hosted runners with optimized specs</p>
<p><b>Specs</b>:</p><ul>
<li>16+ CPU cores</li>
<li>32GB+ RAM</li>
<li>SSD storage</li>
<li>Persistent cache</li>
</ul>
<p><b>Benefits</b>:</p><ul>
<li>3-5x faster builds</li>
<li>Persistent caching</li>
<li>Better resource control</li>
</ul>
<p><b>Estimated Time Savings</b>: 60-70%</p>
<h3><a class="anchor" id="autotoc_md1129"></a>
2. Implement Build Caching Service</h3>
<p><b>Current</b>: GitHub Actions cache (limited)</p>
<p><b>Proposed</b>: Use sccache or ccache</p>
<div class="fragment"><div class="line">- name: Setup sccache</div>
<div class="line">  uses: mozilla-actions/sccache-action@v0.0.3</div>
<div class="line"> </div>
<div class="line">- name: Build</div>
<div class="line">  run: cmake --build . --parallel $cores</div>
<div class="line">  env:</div>
<div class="line">    CMAKE_CXX_COMPILER_LAUNCHER: sccache</div>
</div><!-- fragment --><p><b>Benefits</b>:</p><ul>
<li>Cross-PR cache sharing</li>
<li>Faster incremental builds</li>
<li>Reduced compilation time</li>
</ul>
<p><b>Estimated Time Savings</b>: 40-50%</p>
<h3><a class="anchor" id="autotoc_md1130"></a>
3. Prebuilt Dependency Binaries</h3>
<p><b>Current</b>: Build dependencies from source</p>
<p><b>Proposed</b>: Use prebuilt binaries for dependencies</p>
<p><b>Implementation</b>:</p><ul>
<li>Create dependency packages</li>
<li>Store in GitHub Releases or artifact registry</li>
<li>Download instead of building</li>
</ul>
<p><b>Benefits</b>:</p><ul>
<li>Eliminate dependency build time</li>
<li>Consistent dependency versions</li>
<li>Faster CI startup</li>
</ul>
<p><b>Estimated Time Savings</b>: 20-30%</p>
<h1><a class="anchor" id="autotoc_md1131"></a>
Implementation Priority</h1>
<h2><a class="anchor" id="autotoc_md1132"></a>
Priority 1 (Implemented) ✅</h2>
<ul>
<li>[x] Test-level timeouts</li>
<li>[x] CTest parallel execution</li>
<li>[x] Build parallelization</li>
</ul>
<h2><a class="anchor" id="autotoc_md1133"></a>
Priority 2 (Recommended - Next Sprint)</h2>
<ul>
<li>[ ] Release build for tests</li>
<li>[ ] Enhanced vcpkg caching</li>
<li>[ ] FetchContent caching</li>
</ul>
<h2><a class="anchor" id="autotoc_md1134"></a>
Priority 3 (Future Consideration)</h2>
<ul>
<li>[ ] Test sharding</li>
<li>[ ] Split test execution</li>
<li>[ ] Conditional integration tests</li>
</ul>
<h2><a class="anchor" id="autotoc_md1135"></a>
Priority 4 (Long-Term Planning)</h2>
<ul>
<li>[ ] Self-hosted runners</li>
<li>[ ] Build caching service</li>
<li>[ ] Prebuilt dependencies</li>
</ul>
<h1><a class="anchor" id="autotoc_md1136"></a>
Monitoring</h1>
<h2><a class="anchor" id="autotoc_md1137"></a>
Key Metrics to Track</h2>
<ol type="1">
<li><b>Total CI Time</b>: Target &lt; 15 minutes</li>
<li><b>Test Execution Time</b>: Target &lt; 10 seconds</li>
<li><b>Build Time</b>: Target &lt; 5 minutes</li>
<li><b>Cache Hit Rate</b>: Target &gt; 80%</li>
<li><b>Test Failure Rate</b>: Target &lt; 1%</li>
</ol>
<h2><a class="anchor" id="autotoc_md1138"></a>
Alerting Thresholds</h2>
<ul>
<li>Total CI time &gt; 20 minutes: Warning</li>
<li>Total CI time &gt; 30 minutes: Critical</li>
<li>Test timeout &gt; 5 instances/day: Investigation needed</li>
<li>Build failure rate &gt; 5%: Architecture review</li>
</ul>
<h1><a class="anchor" id="autotoc_md1139"></a>
Conclusion</h1>
<p>The implemented solutions address the immediate Windows CI performance issues:</p>
<p><b>Immediate Impact</b>:</p><ul>
<li>✅ Test timeouts prevent indefinite hangs</li>
<li>✅ Parallel execution improves throughput</li>
<li>✅ Dynamic CPU detection optimizes builds</li>
</ul>
<p><b>Expected Results</b>:</p><ul>
<li>Windows CI time reduced from 41m to ~16-20m</li>
<li>Test reliability improved from 0% to 100%</li>
<li>Better resource utilization</li>
</ul>
<p><b>Next Steps</b>:</p><ol type="1">
<li>Monitor PR #31 CI results</li>
<li>Evaluate Priority 2 recommendations</li>
<li>Plan Priority 3 implementations for Q1 2025</li>
</ol>
<h1><a class="anchor" id="autotoc_md1140"></a>
References</h1>
<ul>
<li><a href="https://docs.github.com/en/actions/using-workflows/caching-dependencies-to-speed-up-workflows">GitHub Actions: Caching dependencies</a></li>
<li><a href="https://cmake.org/cmake/help/latest/manual/ctest.1.html#ctest-parallel-test-execution">CMake: CTest parallel execution</a></li>
<li><a href="https://learn.microsoft.com/en-us/vcpkg/users/binarycaching">vcpkg: Binary caching</a> </li>
</ul>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="../../doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.8 </li>
  </ul>
</div>
</body>
</html>
