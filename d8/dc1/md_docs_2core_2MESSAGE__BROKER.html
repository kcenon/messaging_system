<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Messaging System: Message Broker</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../navtreedata.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/searchdata.js"></script>
<script type="text/javascript" src="../../search/search.js"></script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">Messaging System<span id="projectnumber">&#160;1.0.0</span>
   </div>
   <div id="projectbrief">High-Performance Cross-Platform Messaging Framework</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.8 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "../../search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="../../menudata.js"></script>
<script type="text/javascript" src="../../menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('../../',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('d8/dc1/md_docs_2core_2MESSAGE__BROKER.html','../../'); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Message Broker</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="autotoc_md610"></a> <b>Version</b>: 0.2.1 <b>Last Updated</b>: 2025-12-24 <b>Language</b>: [English]</p>
<hr  />
<h1><a class="anchor" id="autotoc_md612"></a>
Overview</h1>
<p>The <code>message_broker</code> is a central message routing component that provides advanced routing capabilities for the messaging system. It builds upon the <code>topic_router</code> component to offer a higher-level abstraction for managing message routes with priority ordering, statistics collection, and lifecycle management.</p>
<hr  />
<h1><a class="anchor" id="autotoc_md614"></a>
Table of Contents</h1>
<ol type="1">
<li>Features</li>
<li>Architecture</li>
<li>Quick Start</li>
<li>Configuration</li>
<li>Route Management</li>
<li>Message Routing</li>
<li>Content-Based Routing</li>
<li>Statistics</li>
<li>Best Practices</li>
<li>Migration from topic_router</li>
<li>Dead Letter Queue</li>
<li>Planned Features</li>
</ol>
<hr  />
<h1><a class="anchor" id="autotoc_md616"></a>
Features</h1>
<h2><a class="anchor" id="autotoc_md617"></a>
Implemented</h2>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Feature   </th><th class="markdownTableHeadNone">Description   </th><th class="markdownTableHeadNone">Status    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">Route Management   </td><td class="markdownTableBodyNone">Add, remove, enable, disable routes   </td><td class="markdownTableBodyNone">Implemented    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">Topic Pattern Matching   </td><td class="markdownTableBodyNone">MQTT-style wildcards (<code>*</code>, <code>#</code>)   </td><td class="markdownTableBodyNone">Implemented    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">Priority-based Ordering   </td><td class="markdownTableBodyNone">Routes processed by priority (higher first)   </td><td class="markdownTableBodyNone">Implemented    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">Statistics Collection   </td><td class="markdownTableBodyNone">Track routed, delivered, failed messages   </td><td class="markdownTableBodyNone">Implemented    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">Thread-safe Operations   </td><td class="markdownTableBodyNone">Concurrent access with shared_mutex   </td><td class="markdownTableBodyNone">Implemented    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">PIMPL Pattern   </td><td class="markdownTableBodyNone">ABI stability and compile-time isolation   </td><td class="markdownTableBodyNone">Implemented    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">Dead Letter Queue   </td><td class="markdownTableBodyNone">Handle failed messages with replay support   </td><td class="markdownTableBodyNone">Implemented   </td></tr>
</table>
<h2><a class="anchor" id="autotoc_md618"></a>
Planned</h2>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Feature   </th><th class="markdownTableHeadNone">Description   </th><th class="markdownTableHeadNone">Issue    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">Transformation Pipeline   </td><td class="markdownTableBodyNone">Transform messages during routing   </td><td class="markdownTableBodyNone">#183   </td></tr>
</table>
<h2><a class="anchor" id="autotoc_md619"></a>
Recently Added</h2>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Feature   </th><th class="markdownTableHeadNone">Description   </th><th class="markdownTableHeadNone">Version    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">Content-based Routing   </td><td class="markdownTableBodyNone">Route based on message content/headers   </td><td class="markdownTableBodyNone">v0.2.1   </td></tr>
</table>
<hr  />
<h1><a class="anchor" id="autotoc_md621"></a>
Architecture</h1>
<h2><a class="anchor" id="autotoc_md622"></a>
Component Diagram</h2>
<div class="fragment"><div class="line">┌─────────────────────┐</div>
<div class="line">│   message_broker    │</div>
<div class="line">│                     │</div>
<div class="line">│  ┌───────────────┐  │</div>
<div class="line">│  │ Route Manager │  │</div>
<div class="line">│  └───────────────┘  │</div>
<div class="line">│         │           │</div>
<div class="line">│         ▼           │</div>
<div class="line">│  ┌───────────────┐  │</div>
<div class="line">│  │ topic_router  │  │</div>
<div class="line">│  │  (wildcards)  │  │</div>
<div class="line">│  └───────────────┘  │</div>
<div class="line">│         │           │</div>
<div class="line">│         ▼           │</div>
<div class="line">│  ┌───────────────┐  │</div>
<div class="line">│  │  Statistics   │  │</div>
<div class="line">│  └───────────────┘  │</div>
<div class="line">└─────────────────────┘</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md623"></a>
Class Structure</h2>
<div class="fragment"><div class="line"><span class="comment">// Main class uses PIMPL pattern</span></div>
<div class="line"><span class="keyword">class </span>message_broker {</div>
<div class="line"><span class="keyword">public</span>:</div>
<div class="line">    <span class="keyword">explicit</span> message_broker(broker_config config = {});</div>
<div class="line">    ~message_broker();</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// Lifecycle</span></div>
<div class="line">    common::VoidResult start();</div>
<div class="line">    common::VoidResult stop();</div>
<div class="line">    <span class="keywordtype">bool</span> is_running() <span class="keyword">const</span>;</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// Route Management</span></div>
<div class="line">    common::VoidResult add_route(...);</div>
<div class="line">    common::VoidResult remove_route(...);</div>
<div class="line">    common::VoidResult enable_route(...);</div>
<div class="line">    common::VoidResult disable_route(...);</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// Routing</span></div>
<div class="line">    common::VoidResult route(<span class="keyword">const</span> message&amp; msg);</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// Statistics</span></div>
<div class="line">    broker_statistics get_statistics() <span class="keyword">const</span>;</div>
<div class="line"> </div>
<div class="line"><span class="keyword">private</span>:</div>
<div class="line">    std::unique_ptr&lt;message_broker_impl&gt; impl_;</div>
<div class="line">};</div>
</div><!-- fragment --><hr  />
<h1><a class="anchor" id="autotoc_md625"></a>
Quick Start</h1>
<h2><a class="anchor" id="autotoc_md626"></a>
Basic Usage</h2>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;kcenon/messaging/core/message_broker.h&gt;</span></div>
<div class="line"><span class="keyword">using namespace </span>kcenon::messaging;</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">int</span> main() {</div>
<div class="line">    <span class="comment">// Create broker with default configuration</span></div>
<div class="line">    message_broker broker;</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// Start the broker</span></div>
<div class="line">    <span class="keyword">auto</span> start_result = broker.start();</div>
<div class="line">    <span class="keywordflow">if</span> (!start_result.is_ok()) {</div>
<div class="line">        std::cerr &lt;&lt; <span class="stringliteral">&quot;Failed to start broker&quot;</span> &lt;&lt; std::endl;</div>
<div class="line">        <span class="keywordflow">return</span> 1;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// Add a route for user events</span></div>
<div class="line">    broker.add_route(<span class="stringliteral">&quot;user-handler&quot;</span>, <span class="stringliteral">&quot;user.*&quot;</span>, [](<span class="keyword">const</span> message&amp; msg) {</div>
<div class="line">        std::cout &lt;&lt; <span class="stringliteral">&quot;Received: &quot;</span> &lt;&lt; msg.metadata().topic &lt;&lt; std::endl;</div>
<div class="line">        <span class="keywordflow">return</span> common::ok();</div>
<div class="line">    });</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// Route a message</span></div>
<div class="line">    message msg(<span class="stringliteral">&quot;user.created&quot;</span>);</div>
<div class="line">    broker.route(msg);</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// Stop the broker</span></div>
<div class="line">    broker.stop();</div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md627"></a>
With Custom Configuration</h2>
<div class="fragment"><div class="line">broker_config config;</div>
<div class="line">config.max_routes = 500;</div>
<div class="line">config.enable_statistics = <span class="keyword">true</span>;</div>
<div class="line">config.enable_trace_logging = <span class="keyword">false</span>;</div>
<div class="line"> </div>
<div class="line">message_broker broker(config);</div>
<div class="line">broker.start();</div>
</div><!-- fragment --><hr  />
<h1><a class="anchor" id="autotoc_md629"></a>
Configuration</h1>
<h2><a class="anchor" id="autotoc_md630"></a>
broker_config</h2>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Field   </th><th class="markdownTableHeadNone">Type   </th><th class="markdownTableHeadNone">Default   </th><th class="markdownTableHeadNone">Description    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><code>max_routes</code>   </td><td class="markdownTableBodyNone"><code>size_t</code>   </td><td class="markdownTableBodyNone">1000   </td><td class="markdownTableBodyNone">Maximum number of routes allowed    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><code>enable_statistics</code>   </td><td class="markdownTableBodyNone"><code>bool</code>   </td><td class="markdownTableBodyNone">true   </td><td class="markdownTableBodyNone">Enable runtime statistics collection    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><code>enable_trace_logging</code>   </td><td class="markdownTableBodyNone"><code>bool</code>   </td><td class="markdownTableBodyNone">false   </td><td class="markdownTableBodyNone">Enable detailed trace logging    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><code>default_timeout</code>   </td><td class="markdownTableBodyNone"><code>chrono::milliseconds</code>   </td><td class="markdownTableBodyNone">0   </td><td class="markdownTableBodyNone">Default timeout for operations (0 = no timeout)   </td></tr>
</table>
<h2><a class="anchor" id="autotoc_md631"></a>
Example Configuration</h2>
<div class="fragment"><div class="line">broker_config config;</div>
<div class="line">config.max_routes = 100;              <span class="comment">// Limit to 100 routes</span></div>
<div class="line">config.enable_statistics = <span class="keyword">true</span>;       <span class="comment">// Track statistics</span></div>
<div class="line">config.enable_trace_logging = <span class="keyword">false</span>;   <span class="comment">// Disable verbose logging</span></div>
<div class="line">config.default_timeout = std::chrono::milliseconds(5000);  <span class="comment">// 5 second timeout</span></div>
<div class="line"> </div>
<div class="line">message_broker broker(config);</div>
</div><!-- fragment --><hr  />
<h1><a class="anchor" id="autotoc_md633"></a>
Route Management</h1>
<h2><a class="anchor" id="autotoc_md634"></a>
Adding Routes</h2>
<div class="fragment"><div class="line"><span class="comment">// Basic route</span></div>
<div class="line">broker.add_route(<span class="stringliteral">&quot;order-handler&quot;</span>, <span class="stringliteral">&quot;order.*&quot;</span>, order_handler);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Route with priority (0-10, higher = processed first)</span></div>
<div class="line">broker.add_route(<span class="stringliteral">&quot;audit-handler&quot;</span>, <span class="stringliteral">&quot;order.#&quot;</span>, audit_handler, 10);  <span class="comment">// High priority</span></div>
<div class="line">broker.add_route(<span class="stringliteral">&quot;analytics&quot;</span>, <span class="stringliteral">&quot;order.#&quot;</span>, analytics_handler, 1);   <span class="comment">// Low priority</span></div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md635"></a>
Removing Routes</h2>
<div class="fragment"><div class="line"><span class="comment">// Remove a specific route</span></div>
<div class="line"><span class="keyword">auto</span> result = broker.remove_route(<span class="stringliteral">&quot;order-handler&quot;</span>);</div>
<div class="line"><span class="keywordflow">if</span> (!result.is_ok()) {</div>
<div class="line">    std::cerr &lt;&lt; <span class="stringliteral">&quot;Route not found&quot;</span> &lt;&lt; std::endl;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Clear all routes</span></div>
<div class="line">broker.clear_routes();</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md636"></a>
Enabling/Disabling Routes</h2>
<div class="fragment"><div class="line"><span class="comment">// Temporarily disable a route</span></div>
<div class="line">broker.disable_route(<span class="stringliteral">&quot;analytics&quot;</span>);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Re-enable the route</span></div>
<div class="line">broker.enable_route(<span class="stringliteral">&quot;analytics&quot;</span>);</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md637"></a>
Querying Routes</h2>
<div class="fragment"><div class="line"><span class="comment">// Check if route exists</span></div>
<div class="line"><span class="keywordflow">if</span> (broker.has_route(<span class="stringliteral">&quot;order-handler&quot;</span>)) {</div>
<div class="line">    <span class="comment">// Route exists</span></div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Get route information</span></div>
<div class="line"><span class="keyword">auto</span> route_result = broker.get_route(<span class="stringliteral">&quot;order-handler&quot;</span>);</div>
<div class="line"><span class="keywordflow">if</span> (route_result.is_ok()) {</div>
<div class="line">    <span class="keyword">auto</span> info = route_result.value();</div>
<div class="line">    std::cout &lt;&lt; <span class="stringliteral">&quot;Route ID: &quot;</span> &lt;&lt; info.route_id &lt;&lt; std::endl;</div>
<div class="line">    std::cout &lt;&lt; <span class="stringliteral">&quot;Pattern: &quot;</span> &lt;&lt; info.topic_pattern &lt;&lt; std::endl;</div>
<div class="line">    std::cout &lt;&lt; <span class="stringliteral">&quot;Priority: &quot;</span> &lt;&lt; info.priority &lt;&lt; std::endl;</div>
<div class="line">    std::cout &lt;&lt; <span class="stringliteral">&quot;Active: &quot;</span> &lt;&lt; info.active &lt;&lt; std::endl;</div>
<div class="line">    std::cout &lt;&lt; <span class="stringliteral">&quot;Processed: &quot;</span> &lt;&lt; info.messages_processed &lt;&lt; std::endl;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Get all routes</span></div>
<div class="line"><span class="keyword">auto</span> routes = broker.get_routes();</div>
<div class="line"><span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span>&amp; route : routes) {</div>
<div class="line">    std::cout &lt;&lt; route.route_id &lt;&lt; <span class="stringliteral">&quot;: &quot;</span> &lt;&lt; route.topic_pattern &lt;&lt; std::endl;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Get route count</span></div>
<div class="line">std::cout &lt;&lt; <span class="stringliteral">&quot;Total routes: &quot;</span> &lt;&lt; broker.route_count() &lt;&lt; std::endl;</div>
</div><!-- fragment --><hr  />
<h1><a class="anchor" id="autotoc_md639"></a>
Message Routing</h1>
<h2><a class="anchor" id="autotoc_md640"></a>
How Routing Works</h2>
<ol type="1">
<li>Message arrives with a topic</li>
<li>Broker matches topic against all active routes</li>
<li>Matching routes are sorted by priority (highest first)</li>
<li>Message is delivered to each matching handler in order</li>
<li>Statistics are updated</li>
</ol>
<h2><a class="anchor" id="autotoc_md641"></a>
Topic Pattern Matching</h2>
<p>The broker uses MQTT-style wildcard patterns:</p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Pattern   </th><th class="markdownTableHeadNone">Description   </th><th class="markdownTableHeadNone">Example Match    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><code>user.created</code>   </td><td class="markdownTableBodyNone">Exact match   </td><td class="markdownTableBodyNone"><code>user.created</code> only    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><code>user.*</code>   </td><td class="markdownTableBodyNone">Single-level wildcard   </td><td class="markdownTableBodyNone"><code>user.created</code>, <code>user.updated</code>    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><code>user.#</code>   </td><td class="markdownTableBodyNone">Multi-level wildcard   </td><td class="markdownTableBodyNone"><code>user.created</code>, <code>user.profile.updated</code>    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><code>*.user.#</code>   </td><td class="markdownTableBodyNone">Combined wildcards   </td><td class="markdownTableBodyNone"><code>app.user.settings.theme</code>   </td></tr>
</table>
<h2><a class="anchor" id="autotoc_md642"></a>
Routing Example</h2>
<div class="fragment"><div class="line"><span class="comment">// Add routes with different patterns</span></div>
<div class="line">broker.add_route(<span class="stringliteral">&quot;specific&quot;</span>, <span class="stringliteral">&quot;order.created&quot;</span>, handler1);      <span class="comment">// Exact</span></div>
<div class="line">broker.add_route(<span class="stringliteral">&quot;category&quot;</span>, <span class="stringliteral">&quot;order.*&quot;</span>, handler2);            <span class="comment">// Single-level</span></div>
<div class="line">broker.add_route(<span class="stringliteral">&quot;all-orders&quot;</span>, <span class="stringliteral">&quot;order.#&quot;</span>, handler3, 10);      <span class="comment">// Multi-level, high priority</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">// Route a message</span></div>
<div class="line">message msg(<span class="stringliteral">&quot;order.created&quot;</span>);</div>
<div class="line">broker.route(msg);  <span class="comment">// Matches all three routes</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">// Execution order (by priority):</span></div>
<div class="line"><span class="comment">// 1. all-orders (priority 10)</span></div>
<div class="line"><span class="comment">// 2. specific (priority 5, added first)</span></div>
<div class="line"><span class="comment">// 3. category (priority 5, added second)</span></div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md643"></a>
Error Handling</h2>
<div class="fragment"><div class="line"><span class="keyword">auto</span> result = broker.route(msg);</div>
<div class="line"><span class="keywordflow">if</span> (!result.is_ok()) {</div>
<div class="line">    <span class="keyword">auto</span> error = result.error();</div>
<div class="line">    <span class="keywordflow">switch</span> (error.code) {</div>
<div class="line">        <span class="keywordflow">case</span> error_code::broker_not_running:</div>
<div class="line">            std::cerr &lt;&lt; <span class="stringliteral">&quot;Broker is not running&quot;</span> &lt;&lt; std::endl;</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">case</span> error_code::no_matching_routes:</div>
<div class="line">            std::cerr &lt;&lt; <span class="stringliteral">&quot;No routes matched topic&quot;</span> &lt;&lt; std::endl;</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">default</span>:</div>
<div class="line">            std::cerr &lt;&lt; <span class="stringliteral">&quot;Routing failed: &quot;</span> &lt;&lt; error.message &lt;&lt; std::endl;</div>
<div class="line">    }</div>
<div class="line">}</div>
</div><!-- fragment --><hr  />
<h1><a class="anchor" id="autotoc_md645"></a>
Content-Based Routing</h1>
<p>Content-based routing allows you to route messages based on their payload content, metadata headers, message type, or priority, rather than just the topic.</p>
<h2><a class="anchor" id="autotoc_md646"></a>
Content Filter Types</h2>
<p>The <code>content_filters</code> namespace provides helper functions for creating common filters:</p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Filter   </th><th class="markdownTableHeadNone">Description    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><code>has_field(field_name)</code>   </td><td class="markdownTableBodyNone">Check if payload contains a field    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><code>field_equals(field_name, value)</code>   </td><td class="markdownTableBodyNone">Check if field equals a specific value    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><code>field_matches(field_name, pattern)</code>   </td><td class="markdownTableBodyNone">Check if field matches a regex pattern    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><code>metadata_equals(key, value)</code>   </td><td class="markdownTableBodyNone">Check if metadata header equals a value    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><code>message_type_is(type)</code>   </td><td class="markdownTableBodyNone">Check message type    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><code>priority_at_least(priority)</code>   </td><td class="markdownTableBodyNone">Check minimum priority level    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><code>all_of(filters)</code>   </td><td class="markdownTableBodyNone">Combine filters with AND logic    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><code>any_of(filters)</code>   </td><td class="markdownTableBodyNone">Combine filters with OR logic    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><code>not_filter(filter)</code>   </td><td class="markdownTableBodyNone">Negate a filter   </td></tr>
</table>
<h2><a class="anchor" id="autotoc_md647"></a>
Adding Content Routes</h2>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;kcenon/messaging/core/message_broker.h&gt;</span></div>
<div class="line"><span class="keyword">using namespace </span>kcenon::messaging;</div>
<div class="line"><span class="keyword">using namespace </span>kcenon::messaging::content_filters;</div>
<div class="line"> </div>
<div class="line">message_broker broker;</div>
<div class="line">broker.start();</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Route based on metadata header</span></div>
<div class="line">broker.add_content_route(<span class="stringliteral">&quot;eu-orders&quot;</span>,</div>
<div class="line">    metadata_equals(<span class="stringliteral">&quot;region&quot;</span>, <span class="stringliteral">&quot;EU&quot;</span>),</div>
<div class="line">    [](<span class="keyword">const</span> message&amp; msg) {</div>
<div class="line">        <span class="comment">// Handle EU orders</span></div>
<div class="line">        <span class="keywordflow">return</span> common::ok();</div>
<div class="line">    }</div>
<div class="line">);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Route based on message type</span></div>
<div class="line">broker.add_content_route(<span class="stringliteral">&quot;event-handler&quot;</span>,</div>
<div class="line">    message_type_is(message_type::event),</div>
<div class="line">    [](<span class="keyword">const</span> message&amp; msg) {</div>
<div class="line">        <span class="comment">// Handle events only</span></div>
<div class="line">        <span class="keywordflow">return</span> common::ok();</div>
<div class="line">    }</div>
<div class="line">);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Route based on priority</span></div>
<div class="line">broker.add_content_route(<span class="stringliteral">&quot;high-priority-handler&quot;</span>,</div>
<div class="line">    priority_at_least(message_priority::high),</div>
<div class="line">    [](<span class="keyword">const</span> message&amp; msg) {</div>
<div class="line">        <span class="comment">// Handle high priority messages</span></div>
<div class="line">        <span class="keywordflow">return</span> common::ok();</div>
<div class="line">    },</div>
<div class="line">    10  <span class="comment">// priority</span></div>
<div class="line">);</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md648"></a>
Combining Filters</h2>
<div class="fragment"><div class="line"><span class="comment">// Route messages that are events from EU region</span></div>
<div class="line">broker.add_content_route(<span class="stringliteral">&quot;eu-events&quot;</span>,</div>
<div class="line">    all_of({</div>
<div class="line">        metadata_equals(<span class="stringliteral">&quot;region&quot;</span>, <span class="stringliteral">&quot;EU&quot;</span>),</div>
<div class="line">        message_type_is(message_type::event)</div>
<div class="line">    }),</div>
<div class="line">    handler</div>
<div class="line">);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Route messages from EU or UK region</span></div>
<div class="line">broker.add_content_route(<span class="stringliteral">&quot;european-orders&quot;</span>,</div>
<div class="line">    any_of({</div>
<div class="line">        metadata_equals(<span class="stringliteral">&quot;region&quot;</span>, <span class="stringliteral">&quot;EU&quot;</span>),</div>
<div class="line">        metadata_equals(<span class="stringliteral">&quot;region&quot;</span>, <span class="stringliteral">&quot;UK&quot;</span>)</div>
<div class="line">    }),</div>
<div class="line">    handler</div>
<div class="line">);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Route messages that are NOT from EU</span></div>
<div class="line">broker.add_content_route(<span class="stringliteral">&quot;non-eu-orders&quot;</span>,</div>
<div class="line">    not_filter(metadata_equals(<span class="stringliteral">&quot;region&quot;</span>, <span class="stringliteral">&quot;EU&quot;</span>)),</div>
<div class="line">    handler</div>
<div class="line">);</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md649"></a>
Custom Content Filters</h2>
<p>You can create custom filters using lambda expressions:</p>
<div class="fragment"><div class="line"><span class="comment">// Custom filter for high-value orders</span></div>
<div class="line">broker.add_content_route(<span class="stringliteral">&quot;high-value-orders&quot;</span>,</div>
<div class="line">    [](<span class="keyword">const</span> message&amp; msg) -&gt; <span class="keywordtype">bool</span> {</div>
<div class="line">        <span class="keyword">auto</span>&amp; payload = msg.payload();</div>
<div class="line">        <span class="keyword">auto</span> value = payload.get_value(<span class="stringliteral">&quot;order_value&quot;</span>);</div>
<div class="line">        <span class="keywordflow">if</span> (!value.has_value()) <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line">        <span class="keywordflow">return</span> container_module::variant_helpers::to_string(</div>
<div class="line">            value-&gt;data, value-&gt;type) &gt; <span class="stringliteral">&quot;10000&quot;</span>;</div>
<div class="line">    },</div>
<div class="line">    high_value_handler</div>
<div class="line">);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Filter based on topic pattern</span></div>
<div class="line">broker.add_content_route(<span class="stringliteral">&quot;order-filter&quot;</span>,</div>
<div class="line">    [](<span class="keyword">const</span> message&amp; msg) -&gt; <span class="keywordtype">bool</span> {</div>
<div class="line">        <span class="keywordflow">return</span> msg.metadata().topic.find(<span class="stringliteral">&quot;order.&quot;</span>) == 0;</div>
<div class="line">    },</div>
<div class="line">    order_handler</div>
<div class="line">);</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md650"></a>
Managing Content Routes</h2>
<div class="fragment"><div class="line"><span class="comment">// Check if route exists</span></div>
<div class="line"><span class="keywordtype">bool</span> exists = broker.has_content_route(<span class="stringliteral">&quot;eu-orders&quot;</span>);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Get route information</span></div>
<div class="line"><span class="keyword">auto</span> route_result = broker.get_content_route(<span class="stringliteral">&quot;eu-orders&quot;</span>);</div>
<div class="line"><span class="keywordflow">if</span> (route_result.is_ok()) {</div>
<div class="line">    <span class="keyword">auto</span> route = route_result.unwrap();</div>
<div class="line">    std::cout &lt;&lt; <span class="stringliteral">&quot;Route ID: &quot;</span> &lt;&lt; route.route_id &lt;&lt; std::endl;</div>
<div class="line">    std::cout &lt;&lt; <span class="stringliteral">&quot;Active: &quot;</span> &lt;&lt; route.active &lt;&lt; std::endl;</div>
<div class="line">    std::cout &lt;&lt; <span class="stringliteral">&quot;Priority: &quot;</span> &lt;&lt; route.priority &lt;&lt; std::endl;</div>
<div class="line">    std::cout &lt;&lt; <span class="stringliteral">&quot;Messages processed: &quot;</span> &lt;&lt; route.messages_processed &lt;&lt; std::endl;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Get all content routes</span></div>
<div class="line"><span class="keyword">auto</span> routes = broker.get_content_routes();</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Get route count</span></div>
<div class="line"><span class="keywordtype">size_t</span> count = broker.content_route_count();</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Enable/disable routes</span></div>
<div class="line">broker.disable_content_route(<span class="stringliteral">&quot;eu-orders&quot;</span>);</div>
<div class="line">broker.enable_content_route(<span class="stringliteral">&quot;eu-orders&quot;</span>);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Remove a route</span></div>
<div class="line">broker.remove_content_route(<span class="stringliteral">&quot;eu-orders&quot;</span>);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Clear all content routes</span></div>
<div class="line">broker.clear_content_routes();</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md651"></a>
Routing by Content</h2>
<div class="fragment"><div class="line"><span class="comment">// Route a message using content-based routing</span></div>
<div class="line">message msg(<span class="stringliteral">&quot;orders.new&quot;</span>);</div>
<div class="line">msg.metadata().headers[<span class="stringliteral">&quot;region&quot;</span>] = <span class="stringliteral">&quot;EU&quot;</span>;</div>
<div class="line"> </div>
<div class="line"><span class="keyword">auto</span> result = broker.route_by_content(msg);</div>
<div class="line"><span class="keywordflow">if</span> (result.is_err()) {</div>
<div class="line">    std::cout &lt;&lt; <span class="stringliteral">&quot;No matching routes or handler failed&quot;</span> &lt;&lt; std::endl;</div>
<div class="line">}</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md652"></a>
Content vs Topic Routing</h2>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Aspect   </th><th class="markdownTableHeadNone">Topic Routing   </th><th class="markdownTableHeadNone">Content-Based Routing    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">Method   </td><td class="markdownTableBodyNone"><code>route()</code>   </td><td class="markdownTableBodyNone"><code>route_by_content()</code>    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">Matching   </td><td class="markdownTableBodyNone">Topic pattern   </td><td class="markdownTableBodyNone">Filter predicate    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">Performance   </td><td class="markdownTableBodyNone">O(1) hash lookup   </td><td class="markdownTableBodyNone">O(n) filter evaluation    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">Use case   </td><td class="markdownTableBodyNone">Simple routing   </td><td class="markdownTableBodyNone">Complex routing logic    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">Multiple matches   </td><td class="markdownTableBodyNone">All matching handlers   </td><td class="markdownTableBodyNone">All matching handlers   </td></tr>
</table>
<h2><a class="anchor" id="autotoc_md653"></a>
Best Practices</h2>
<ol type="1">
<li><b>Use topic routing when possible</b>: It's more efficient than content-based routing</li>
<li><b>Order by specificity</b>: Higher priority for more specific filters</li>
<li><b>Handle exceptions</b>: Filters should not throw; wrap in try-catch if needed</li>
<li><b>Monitor statistics</b>: Track <code>messages_processed</code> to identify hot routes</li>
</ol>
<hr  />
<h1><a class="anchor" id="autotoc_md655"></a>
Statistics</h1>
<h2><a class="anchor" id="autotoc_md656"></a>
Available Statistics</h2>
<div class="fragment"><div class="line"><span class="keyword">struct </span>broker_statistics {</div>
<div class="line">    uint64_t messages_routed;     <span class="comment">// Total routing attempts</span></div>
<div class="line">    uint64_t messages_delivered;  <span class="comment">// Successfully delivered</span></div>
<div class="line">    uint64_t messages_failed;     <span class="comment">// Handler returned error</span></div>
<div class="line">    uint64_t messages_unrouted;   <span class="comment">// No matching routes</span></div>
<div class="line">    uint64_t active_routes;       <span class="comment">// Current active routes</span></div>
<div class="line">    std::chrono::steady_clock::time_point last_reset;</div>
<div class="line">};</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md657"></a>
Using Statistics</h2>
<div class="fragment"><div class="line"><span class="keyword">auto</span> stats = broker.get_statistics();</div>
<div class="line"> </div>
<div class="line">std::cout &lt;&lt; <span class="stringliteral">&quot;Messages routed: &quot;</span> &lt;&lt; stats.messages_routed &lt;&lt; std::endl;</div>
<div class="line">std::cout &lt;&lt; <span class="stringliteral">&quot;Delivered: &quot;</span> &lt;&lt; stats.messages_delivered &lt;&lt; std::endl;</div>
<div class="line">std::cout &lt;&lt; <span class="stringliteral">&quot;Failed: &quot;</span> &lt;&lt; stats.messages_failed &lt;&lt; std::endl;</div>
<div class="line">std::cout &lt;&lt; <span class="stringliteral">&quot;Unrouted: &quot;</span> &lt;&lt; stats.messages_unrouted &lt;&lt; std::endl;</div>
<div class="line">std::cout &lt;&lt; <span class="stringliteral">&quot;Active routes: &quot;</span> &lt;&lt; stats.active_routes &lt;&lt; std::endl;</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Calculate success rate</span></div>
<div class="line"><span class="keywordflow">if</span> (stats.messages_routed &gt; 0) {</div>
<div class="line">    <span class="keywordtype">double</span> success_rate = 100.0 * stats.messages_delivered / stats.messages_routed;</div>
<div class="line">    std::cout &lt;&lt; <span class="stringliteral">&quot;Success rate: &quot;</span> &lt;&lt; success_rate &lt;&lt; <span class="stringliteral">&quot;%&quot;</span> &lt;&lt; std::endl;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Reset statistics</span></div>
<div class="line">broker.reset_statistics();</div>
</div><!-- fragment --><hr  />
<h1><a class="anchor" id="autotoc_md659"></a>
Best Practices</h1>
<h2><a class="anchor" id="autotoc_md660"></a>
1. Use Meaningful Route IDs</h2>
<div class="fragment"><div class="line"><span class="comment">// Good: Descriptive and unique</span></div>
<div class="line">broker.add_route(<span class="stringliteral">&quot;order-notification-handler&quot;</span>, <span class="stringliteral">&quot;order.created&quot;</span>, handler);</div>
<div class="line">broker.add_route(<span class="stringliteral">&quot;user-audit-logger&quot;</span>, <span class="stringliteral">&quot;user.#&quot;</span>, logger);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Bad: Generic or duplicate-prone</span></div>
<div class="line">broker.add_route(<span class="stringliteral">&quot;handler1&quot;</span>, <span class="stringliteral">&quot;order.created&quot;</span>, handler);</div>
<div class="line">broker.add_route(<span class="stringliteral">&quot;handler&quot;</span>, <span class="stringliteral">&quot;user.#&quot;</span>, logger);</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md661"></a>
2. Set Appropriate Priorities</h2>
<div class="fragment"><div class="line"><span class="comment">// Critical handlers first</span></div>
<div class="line">broker.add_route(<span class="stringliteral">&quot;validation&quot;</span>, <span class="stringliteral">&quot;order.*&quot;</span>, validate, 10);</div>
<div class="line">broker.add_route(<span class="stringliteral">&quot;processing&quot;</span>, <span class="stringliteral">&quot;order.*&quot;</span>, process, 5);</div>
<div class="line">broker.add_route(<span class="stringliteral">&quot;analytics&quot;</span>, <span class="stringliteral">&quot;order.*&quot;</span>, track, 1);</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md662"></a>
3. Handle Errors in Handlers</h2>
<div class="fragment"><div class="line">broker.add_route(<span class="stringliteral">&quot;safe-handler&quot;</span>, <span class="stringliteral">&quot;data.*&quot;</span>, [](<span class="keyword">const</span> message&amp; msg) {</div>
<div class="line">    <span class="keywordflow">try</span> {</div>
<div class="line">        process(msg);</div>
<div class="line">        <span class="keywordflow">return</span> common::ok();</div>
<div class="line">    } <span class="keywordflow">catch</span> (<span class="keyword">const</span> std::exception&amp; e) {</div>
<div class="line">        <span class="keywordflow">return</span> common::error(error_code::handler_failed, e.what());</div>
<div class="line">    }</div>
<div class="line">});</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md663"></a>
4. Monitor Statistics</h2>
<div class="fragment"><div class="line"><span class="comment">// Periodic health check</span></div>
<div class="line"><span class="keywordtype">void</span> check_broker_health(<span class="keyword">const</span> message_broker&amp; broker) {</div>
<div class="line">    <span class="keyword">auto</span> stats = broker.get_statistics();</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (stats.messages_unrouted &gt; 100) {</div>
<div class="line">        log_warning(<span class="stringliteral">&quot;High number of unrouted messages&quot;</span>);</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (stats.messages_failed &gt; stats.messages_delivered * 0.1) {</div>
<div class="line">        log_error(<span class="stringliteral">&quot;More than 10% of messages failing&quot;</span>);</div>
<div class="line">    }</div>
<div class="line">}</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md664"></a>
5. Graceful Shutdown</h2>
<div class="fragment"><div class="line"><span class="comment">// Stop accepting new routes</span></div>
<div class="line"><span class="comment">// Wait for pending routes to complete</span></div>
<div class="line">broker.stop();</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Then clear routes if needed</span></div>
<div class="line">broker.clear_routes();</div>
</div><!-- fragment --><hr  />
<h1><a class="anchor" id="autotoc_md666"></a>
Migration from topic_router</h1>
<p>If you're currently using <code>topic_router</code> directly, here's how to migrate to <code>message_broker</code>:</p>
<h2><a class="anchor" id="autotoc_md667"></a>
Before (topic_router)</h2>
<div class="fragment"><div class="line">topic_router router;</div>
<div class="line">router.add_pattern(<span class="stringliteral">&quot;user.*&quot;</span>, [](<span class="keyword">const</span> message&amp; msg) {</div>
<div class="line">    <span class="comment">// Handle</span></div>
<div class="line">});</div>
<div class="line">router.route(msg);</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md668"></a>
After (message_broker)</h2>
<div class="fragment"><div class="line">message_broker broker;</div>
<div class="line">broker.start();</div>
<div class="line"> </div>
<div class="line">broker.add_route(<span class="stringliteral">&quot;user-handler&quot;</span>, <span class="stringliteral">&quot;user.*&quot;</span>, [](<span class="keyword">const</span> message&amp; msg) {</div>
<div class="line">    <span class="comment">// Handle</span></div>
<div class="line">    <span class="keywordflow">return</span> common::ok();  <span class="comment">// Note: Return Result now</span></div>
<div class="line">});</div>
<div class="line"> </div>
<div class="line">broker.route(msg);</div>
<div class="line">broker.stop();</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md669"></a>
Key Differences</h2>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Aspect   </th><th class="markdownTableHeadNone">topic_router   </th><th class="markdownTableHeadNone">message_broker    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">Lifecycle   </td><td class="markdownTableBodyNone">None   </td><td class="markdownTableBodyNone">start()/stop() required    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">Return type   </td><td class="markdownTableBodyNone">void   </td><td class="markdownTableBodyNone">common::VoidResult    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">Route ID   </td><td class="markdownTableBodyNone">Not required   </td><td class="markdownTableBodyNone">Required    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">Priority   </td><td class="markdownTableBodyNone">Not supported   </td><td class="markdownTableBodyNone">Supported    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">Statistics   </td><td class="markdownTableBodyNone">Not available   </td><td class="markdownTableBodyNone">Available    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">Enable/Disable   </td><td class="markdownTableBodyNone">Not supported   </td><td class="markdownTableBodyNone">Supported   </td></tr>
</table>
<hr  />
<h1><a class="anchor" id="autotoc_md671"></a>
Dead Letter Queue</h1>
<p>The message broker includes a fully-featured Dead Letter Queue (DLQ) for handling failed messages.</p>
<h2><a class="anchor" id="autotoc_md672"></a>
DLQ Configuration</h2>
<div class="fragment"><div class="line">dlq_config config;</div>
<div class="line">config.max_size = 10000;                        <span class="comment">// Maximum DLQ capacity</span></div>
<div class="line">config.retention_period = std::chrono::hours(24);  <span class="comment">// 24 hour retention</span></div>
<div class="line">config.on_full = dlq_policy::drop_oldest;       <span class="comment">// Overflow policy</span></div>
<div class="line">config.enable_automatic_retry = <span class="keyword">false</span>;          <span class="comment">// Manual replay only</span></div>
<div class="line">config.capture_unrouted = <span class="keyword">false</span>;                <span class="comment">// Don&#39;t capture unrouted</span></div>
<div class="line"> </div>
<div class="line">broker.configure_dlq(config);</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md673"></a>
DLQ Configuration Options</h2>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Option   </th><th class="markdownTableHeadNone">Type   </th><th class="markdownTableHeadNone">Default   </th><th class="markdownTableHeadNone">Description    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><code>max_size</code>   </td><td class="markdownTableBodyNone"><code>size_t</code>   </td><td class="markdownTableBodyNone">10000   </td><td class="markdownTableBodyNone">Maximum messages in DLQ    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><code>retention_period</code>   </td><td class="markdownTableBodyNone"><code>chrono::seconds</code>   </td><td class="markdownTableBodyNone">3600   </td><td class="markdownTableBodyNone">Message retention time    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><code>on_full</code>   </td><td class="markdownTableBodyNone"><code>dlq_policy</code>   </td><td class="markdownTableBodyNone">drop_oldest   </td><td class="markdownTableBodyNone">Policy when full    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><code>enable_automatic_retry</code>   </td><td class="markdownTableBodyNone"><code>bool</code>   </td><td class="markdownTableBodyNone">false   </td><td class="markdownTableBodyNone">Auto-retry failed messages    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><code>max_auto_retries</code>   </td><td class="markdownTableBodyNone"><code>size_t</code>   </td><td class="markdownTableBodyNone">3   </td><td class="markdownTableBodyNone">Max auto-retry attempts    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><code>retry_delay</code>   </td><td class="markdownTableBodyNone"><code>chrono::milliseconds</code>   </td><td class="markdownTableBodyNone">1000   </td><td class="markdownTableBodyNone">Delay between retries    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><code>capture_unrouted</code>   </td><td class="markdownTableBodyNone"><code>bool</code>   </td><td class="markdownTableBodyNone">false   </td><td class="markdownTableBodyNone">Move unrouted to DLQ   </td></tr>
</table>
<h2><a class="anchor" id="autotoc_md674"></a>
Overflow Policies</h2>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Policy   </th><th class="markdownTableHeadNone">Description    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><code>drop_oldest</code>   </td><td class="markdownTableBodyNone">Drop oldest message when full    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><code>drop_newest</code>   </td><td class="markdownTableBodyNone">Reject new messages when full    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><code>block</code>   </td><td class="markdownTableBodyNone">Block routing when full   </td></tr>
</table>
<h2><a class="anchor" id="autotoc_md675"></a>
Moving Messages to DLQ</h2>
<div class="fragment"><div class="line"><span class="comment">// Manually move a failed message to DLQ</span></div>
<div class="line">broker.move_to_dlq(msg, <span class="stringliteral">&quot;Handler threw exception: database unavailable&quot;</span>);</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md676"></a>
Querying DLQ</h2>
<div class="fragment"><div class="line"><span class="comment">// Get DLQ size</span></div>
<div class="line">std::size_t size = broker.get_dlq_size();</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Get DLQ messages (limited)</span></div>
<div class="line"><span class="keyword">auto</span> messages = broker.get_dlq_messages(10);  <span class="comment">// Get first 10</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">// Get all DLQ messages</span></div>
<div class="line"><span class="keyword">auto</span> all_messages = broker.get_dlq_messages();  <span class="comment">// Get all</span></div>
<div class="line"> </div>
<div class="line"><span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span>&amp; entry : messages) {</div>
<div class="line">    std::cout &lt;&lt; <span class="stringliteral">&quot;Message: &quot;</span> &lt;&lt; entry.original_message.metadata().id &lt;&lt; std::endl;</div>
<div class="line">    std::cout &lt;&lt; <span class="stringliteral">&quot;Reason: &quot;</span> &lt;&lt; entry.failure_reason &lt;&lt; std::endl;</div>
<div class="line">    std::cout &lt;&lt; <span class="stringliteral">&quot;Failed at: &quot;</span> &lt;&lt; <span class="comment">/* format timestamp */</span> &lt;&lt; std::endl;</div>
<div class="line">    std::cout &lt;&lt; <span class="stringliteral">&quot;Retries: &quot;</span> &lt;&lt; entry.retry_count &lt;&lt; std::endl;</div>
<div class="line">}</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md677"></a>
Replaying Messages</h2>
<div class="fragment"><div class="line"><span class="comment">// Replay a specific message</span></div>
<div class="line"><span class="keyword">auto</span> result = broker.replay_dlq_message(message_id);</div>
<div class="line"><span class="keywordflow">if</span> (result.is_ok()) {</div>
<div class="line">    std::cout &lt;&lt; <span class="stringliteral">&quot;Message replayed successfully&quot;</span> &lt;&lt; std::endl;</div>
<div class="line">} <span class="keywordflow">else</span> {</div>
<div class="line">    std::cout &lt;&lt; <span class="stringliteral">&quot;Replay failed: &quot;</span> &lt;&lt; result.error().message &lt;&lt; std::endl;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Replay all messages</span></div>
<div class="line">std::size_t replayed = broker.replay_all_dlq_messages();</div>
<div class="line">std::cout &lt;&lt; <span class="stringliteral">&quot;Replayed &quot;</span> &lt;&lt; replayed &lt;&lt; <span class="stringliteral">&quot; messages&quot;</span> &lt;&lt; std::endl;</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md678"></a>
Purging DLQ</h2>
<div class="fragment"><div class="line"><span class="comment">// Purge all messages</span></div>
<div class="line">std::size_t purged = broker.purge_dlq();</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Purge old messages (older than 1 hour)</span></div>
<div class="line">std::size_t purged = broker.purge_dlq_older_than(std::chrono::hours(1));</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md679"></a>
DLQ Statistics</h2>
<div class="fragment"><div class="line"><span class="keyword">auto</span> stats = broker.get_dlq_statistics();</div>
<div class="line"> </div>
<div class="line">std::cout &lt;&lt; <span class="stringliteral">&quot;Current size: &quot;</span> &lt;&lt; stats.current_size &lt;&lt; std::endl;</div>
<div class="line">std::cout &lt;&lt; <span class="stringliteral">&quot;Total received: &quot;</span> &lt;&lt; stats.total_received &lt;&lt; std::endl;</div>
<div class="line">std::cout &lt;&lt; <span class="stringliteral">&quot;Total replayed: &quot;</span> &lt;&lt; stats.total_replayed &lt;&lt; std::endl;</div>
<div class="line">std::cout &lt;&lt; <span class="stringliteral">&quot;Total purged: &quot;</span> &lt;&lt; stats.total_purged &lt;&lt; std::endl;</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Failure reason breakdown</span></div>
<div class="line"><span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span>&amp; [reason, count] : stats.failure_reasons) {</div>
<div class="line">    std::cout &lt;&lt; reason &lt;&lt; <span class="stringliteral">&quot;: &quot;</span> &lt;&lt; count &lt;&lt; std::endl;</div>
<div class="line">}</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md680"></a>
DLQ Event Callbacks</h2>
<div class="fragment"><div class="line"><span class="comment">// Callback when message enters DLQ</span></div>
<div class="line">broker.on_dlq_message([](<span class="keyword">const</span> dlq_entry&amp; entry) {</div>
<div class="line">    log_error(<span class="stringliteral">&quot;Message moved to DLQ: &quot;</span> + entry.original_message.metadata().id +</div>
<div class="line">              <span class="stringliteral">&quot;, reason: &quot;</span> + entry.failure_reason);</div>
<div class="line">});</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Callback when DLQ is full</span></div>
<div class="line">broker.on_dlq_full([](std::size_t size) {</div>
<div class="line">    send_alert(<span class="stringliteral">&quot;DLQ is full! Size: &quot;</span> + std::to_string(size));</div>
<div class="line">});</div>
</div><!-- fragment --><hr  />
<h1><a class="anchor" id="autotoc_md682"></a>
Planned Features</h1>
<p>The following features are planned for future releases:</p>
<h2><a class="anchor" id="autotoc_md683"></a>
Transformation Pipeline (#183)</h2>
<p>Transform messages during routing.</p>
<div class="fragment"><div class="line"><span class="comment">// Planned API</span></div>
<div class="line">broker.add_route(<span class="stringliteral">&quot;enriched&quot;</span>, <span class="stringliteral">&quot;order.*&quot;</span>, handler)</div>
<div class="line">    .transform([](message&amp; msg) {</div>
<div class="line">        msg.add_header(<span class="stringliteral">&quot;processed_at&quot;</span>, timestamp());</div>
<div class="line">        <span class="keywordflow">return</span> msg;</div>
<div class="line">    });</div>
</div><!-- fragment --><hr  />
<h1><a class="anchor" id="autotoc_md685"></a>
See Also</h1>
<ul>
<li><a href="../../../API_REFERENCE.md#message-broker-api">API Reference</a></li>
<li><a href="../../../API_REFERENCE.md#topic-routing">Topic Router</a></li>
<li><a href="../../../API_REFERENCE.md#message-bus-api">Message Bus</a></li>
<li><a href="../../../FEATURES.md#message-broker">FEATURES</a></li>
</ul>
<hr  />
<p><b>Last Updated</b>: 2025-12-24 <b>Version</b>: 0.2.1 </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="../../doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.8 </li>
  </ul>
</div>
</body>
</html>
